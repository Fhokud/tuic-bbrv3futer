- name: Create and publish release
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          # Create draft release with changelog
          gh release create "$TAG_NAME" \
            --draft \
            --notes "${{ steps.git-cliff.outputs.content }}"

          # Upload all package files (safe for spaces, (), etc.)
          if [ -d "./packages" ]; then
            find ./packages -type f -print0 \
              | xargs -0 -I {} gh release upload "$TAG_NAME" "{}" --clobber
          fi

          # Upload LICENSE file
          gh release upload "$TAG_NAME" LICENSE --clobber

          # Publish the release
          gh release edit "$TAG_NAME" --draft=false